## 脚印留痕

脚印留痕尝试了两种做法

1.	曲面细分+粒子发射+顶点偏移 缺点：整个平面进行了曲面细分，因此不适用于大场景，后期优化：做一个划分区域的曲面细分；并且需要为每个角色进行绑定才行，对于不同的物体来说可能工作量大，并且痕迹的形状受限于给的贴图，所以可能不会像原神那样的广泛性，比如非人性怪物啥的。
2.	视差贴图+Graphics.Blit  缺点：没有做真实的顶点偏移，且目前实现的脚印痕迹消散只有角色再次移动的时候才会消散。另外，超出绘制范围的时候就变得很头疼了，无限延长，且贴图的纹理大小也需要仔细调整才行。

针对上述：有博客写道可以使用两张深度贴图，一张从上方捕捉地形，一张从下方捕捉物体，合并计算段一张物体陷入沙地的贴图，其中R表示凹陷，后处理时G生成描边并模糊，地面shader用这张图作为高度图，配合曲面细分。这样做的好处是，痕迹的形状不会受贴图影响，因为直接计算的是与地面接触的mesh，此外也是实现局部区域曲面细分，不用对整个平面细分。
[https://noirccc.net/blog/zh/posts/773]
### 方法一的实现。
1.	在玩家脚步绑定两个粒子发射器，两张贴图的a通道内容不同，一个表示凹陷，一个表示突起。
2.	玩家顶部设置一个正交摄像机跟随玩家移动，这个正交摄像机会输出一个renderTexture来记录脚印。通过代码把摄像机的位置/大小/输出的RT传入地形shader里。
3.	曲面细分的步骤：【顶点阶段数据接收】【细分规则配置】【计算插值权重】【细分后的顶点属性计算】

【顶点阶段数据接收】需要设定相应的结构体来接收。

【细分规则设置】
```
struct PatchTess //曲面细分规则配置，如何对一个三角面进行细分，需要设hi三角形各边要分成几段，以及三角形内部有几个新加的点
{
    float EdgeTess[3]:SV_TessFactor; //各边细分数
    float InsideTess:SV_InsideTessFactor; //内部细分点系数
};
PatchTess ConstantHS(InputPatch<Varyings,3> patch,uint patchID:SV_PrimitiveID)//具体怎么分
{
    PatchTess pt;
    pt.EdgeTess[0]=_Tesselation; //第一条边的的细分段数
    pt.EdgeTess[1]=_Tesselation; //第二条边的细分段数
    pt.EdgeTess[2]=_Tesselation; //第三条边的细分段数
    pt.InsideTess=_Tesselation;  //内部细分点系数
    return pt;
                
}
```

【计算插值权重】
```
//计算插值权重，这是不可编程的，这里是得到每个顶点的插值权重，真正的混合需要我们在下一个阶段手动计算 
[domain("tri")] //图元类型，三角面片
[partitioning("integer")] // 曲面细分的过度方式是整数还是小数，这里是整数
[outputtopology("triangle_cw")] //三角面正方向是顺时针还是逆时针，这里是顺时针
[outputcontrolpoints(3)] //输出的控制点数
[patchconstantfunc("ConstantHS")] //对之前的细分规则配置阶段的方法名
[maxtessfactor(64.0f)] //最大可能的细分段数
```
【细分后的顶点属性计算】对顶点做权重混合，并且对得到RT对顶点做偏移。
 
【片元着色器】在片元着色器中需要将得到RT高度转为法线，因为顶点偏移后法线并没有改变，为了正确的光照效果，这是必要的，此外还可以加点噪声处理，模糊脚印边缘。
 
